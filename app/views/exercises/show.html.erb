<%
  content_for(:title, @exercise.title)
  content_for(:description, @exercise.description)
%>
<header class="mb-6">
  <%= render layout: "users/layouts/user_heading", locals: {user: @exercise.user, posted_at: @exercise.created_at} do %>
    <h1 class="text-3xl"><%= @exercise.title %></h1>
    <p class="mb-3"><%= @exercise.description %></p>
    <ul class="text-sm flex space-x-3">
      <% @exercise.categories.each do |category| %>
        <li>
          <%= link_to category.name, by_slug_categories_path(category), data: {turbo: false}, class: "px-2 py-1 bg-blue-100 rounded-lg text-xs" %>
        </li>
      <% end %>
    </ul>
  <% end %>
</header>

<div class="grid grid-cols-1 items-start gap-8 lg:grid-cols-3">
  <% if @exercise.original %>
   <div class="flex space-x-6 col-span-3 bg-white p-4 rounded-lg items-center  shadow-lg">
    <figure class="flex-shrink-0">
      <a href="<%= user_url(@exercise.user) %>" data-turbo="false">
        <%= render partial: "users/avatar", locals: {user: @exercise.original.user, size: 12} %>
      </a>
    </figure>
    <span>
      Cet exercice est une version originale de l'exercice suivant:
      <strong><%= link_to @exercise.original.title, @exercise.original %></strong>.
    </span>
   </div>
  <% end %>

  <!-- Left column -->
  <div class="grid grid-cols-1 gap-4 lg:col-span-2">
    <section aria-labelledby="section-1-title">
      <!-- VIDEO AND PRACTICE TOOLS -->
      <youtube-player data-application-target="videoPlayer" video-id="<%= @exercise.video_link %>">
        <div class="bg-white flex items-center justify-center h-[450px] rounded-lg shadow-lg" slot="empty">
          <div class="text-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
            </svg>
            <p class="my-6 text-sm font-light text-center">Aucune vidéo disponible</p>
          </div>
        </div>
      </youtube-player>
      <!-- END VIDEO AND PRACTICE TOOLS -->
    </section>
  </div>

  <!-- Right column -->
  <div class="grid grid-cols-1 gap-4">
    <section aria-labelledby="section-2-title">
      <div class="rounded-lg bg-white shadow-lg p-6">
        <% if current_user.present? %>
          <div class="p-6">
            <%= render partial: "practices/adding_time", locals: {exercise: @exercise} %>
            <% if @exercise.goal_end.present? %>
              <div class="pt-6">
                <p class="mb-6 text-sm font-light text-gray-600">Mise à jour de l'objectif</p>
                <%= turbo_frame_tag "goal_setting_form" do %>
                  <%= render partial: "exercises/goal_settings/form", locals: {exercise: @exercise, goal_setting: @goal_setting} %>
                <% end %>
              </div>
            <% end %>
          </div>
          <% if @exercise.media.count > 0 %>
            <div>
              <p class="m-6 text-sm font-light text-gray-600">Ressources partagées par l'auteur de l'exercice</p>
              <%= render layout: 'shared/layouts/tiles_list', locals: { items: @exercise.media} do |item, section| %>
                <%- case section when :icon -%>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.112 2.13" />
                  </svg>
                <%- when :title -%>
                  <%= link_to item.file.filename, url_for(item.file), { target: '_blank', data: {turbo: false}, class: "block px-4 py-2 text-sm text-gray-700" } %>
                <%- when :description -%>
                  <%= item.file.metadata['size'] %> Octets · Public · <%= item.created_at %>
                <%- when :actions -%>
                  <% if can? :manage, item %>
                    <div class="relative" data-controller="dropdown" data-dropdown-toggle-class="hidden">
                    <button type="button" data-dropdown-target="button"
                      data-action="click->dropdown#toggle"
                      class="flex items-center text-gray-400 bg-gray-100 rounded-full hover:text-gray-600 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-gray-100" id="menu-button" aria-expanded="true" aria-haspopup="true">
                      <span class="sr-only">Open options</span>
                      <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path d="M10 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM10 8.5a1.5 1.5 0 110 3 1.5 1.5 0 010-3zM11.5 15.5a1.5 1.5 0 10-3 0 1.5 1.5 0 003 0z" />
                      </svg>
                    </button>
                    <div
                      data-dropdown-target="menu"
                      class="hidden absolute right-0 z-10 mt-4 w-56 bg-white rounded-md ring-1 ring-black ring-opacity-5 shadow-lg origin-top-right focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="menu-button" tabindex="-1">
                      <div class="py-1" role="none">
                        <%= link_to "Ouvrir", url_for(item.file), { target: '_blank', data: {turbo: false}, class: "block px-4 py-2 text-sm text-gray-700" } %>
                        <%= link_to "Téléchargement", item.file, { target: '_blank', data: {turbo: false}, download: true, class: "block px-4 py-2 text-sm text-gray-700" } %>
                      </div>
                    </div>
                  </div>
                    <%- end -%>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p>Connectez vous ou inscrivez vous pour profiter de nos outils de pratique.</p>
        <% end %>
      </div>
    </section>
  </div>
</div>

<div class="relative my-16">
  <div class="absolute inset-0 flex items-center" aria-hidden="true">
    <div class="w-full border-t border-gray-300"></div>
  </div>
  <div class="relative flex justify-center">
    <span class="bg-gray-100 px-2 text-sm text-gray-500">
      <h2 class="text-lg lg:text-2xl font-bold text-gray-900 dark:text-white">Contenu de l'exercice</h2>
    </span>
  </div>
</div>

<div class="prose">
  <%= sanitize renderHtml @exercise.body %>
</div>

<div class="relative my-16">
  <div class="absolute inset-0 flex items-center" aria-hidden="true">
    <div class="w-full border-t border-gray-300"></div>
  </div>
  <div class="relative flex justify-center">
    <span class="bg-gray-100 px-2 text-sm text-gray-500">
      <h2 class="text-lg lg:text-2xl font-bold text-gray-900 dark:text-white">Autres versions</h2>
    </span>
  </div>
</div>

<div>
  <%= turbo_frame_tag "exercise_versions", src: exercise_versions_path(@exercise) do %>
    <%#= render partial: "exercises/versions/list_skeleton" %>
  <% end %>
</div>


<div class="relative my-16">
  <div class="absolute inset-0 flex items-center" aria-hidden="true">
    <div class="w-full border-t border-gray-300"></div>
  </div>
  <div class="relative flex justify-center">
    <span class="bg-gray-100 px-2 text-sm text-gray-500">
      <h2 class="text-lg lg:text-2xl font-bold text-gray-900 dark:text-white">Discussion (<%= @exercise.comments.count %>)</h2>
    </span>
  </div>
</div>

<footer>
  <% if user_signed_in? %>
    <%= turbo_frame_tag "comment_new" do %>
      <%= render partial: "comments/form",
        locals: {
          comment: Comment.new, commentable: @exercise, first: true
        } %>
    <% end %>
  <% end %>

  <!-- Turbo load comments list + Skeleton -->
  <%= turbo_frame_tag "#{dom_id(@exercise)}_comments", src: exercise_comments_path(@exercise), loading: :lazy do %>
    <%#= render partial: "exercises/versions/list_skeleton" %>
  <% end %>
</footer>

